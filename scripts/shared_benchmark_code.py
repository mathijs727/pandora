import subprocess
import os
import shutil

torque_exe = "C:/Users/Mathijs/Documents/GitHub/pandora/out/build/x64-Release/torque.exe"
files_of_interest = ["output.jpg", "num_top_level_intersections.exr", "stats.json"]


def run_pandora(arguments, out_folder):
    pandora_path = os.path.dirname(torque_exe)

    # Remove files of interest so we don't accidentaly copy over junk files if the Pandora crashes but returns exit code 0
    for filename in files_of_interest:
        filepath = os.path.join(pandora_path, filename)
        if os.path.exists(filepath):
            os.remove(filepath)

    try:
        output = subprocess.check_output(
            [torque_exe] + [str(arg) for arg in arguments], cwd=pandora_path)
    except Exception as e:
        print(f"Error running pandora:\n{e}")
        return

    if not os.path.exists(out_folder):
        os.makedirs(out_folder)

    try:
        # Store the output (cout) to the output folder
        with open(os.path.join(out_folder, "cout.txt"), "w", newline='') as f:
            f.write(output.decode("utf-8"))

        # Copy files generated by Pandora (like stats & final image) to the output folder
        for filename in files_of_interest:
            shutil.copyfile(os.path.join(pandora_path, filename),
                            os.path.join(out_folder, filename))
    except Exception as e:
        print(f"Error copying results:\n{e}")
        return


def get_scenes():
    return [
        {
            "name": "crown",
            "file": "F:/Pandora Scenes/PBF/crown-pbf11.pbf",
            "subdiv": 4,
            "batch_point_size": 8100000, # 8.1M => 56 batching points
            "max_geom_mem_mb": 6893,  # 6.893GB => 6,892,335,216 bytes
            "max_bvh_mem_mb": 212100,  # 21.210GB => 21,209,230,208 bytes
            "svdag_mem_usage128": 1781092 # 1,781,092 bytes after compression
        },
        {
            "name": "landscape",
            "file": "F:/Pandora Scenes/PBF/landscape-view0-halfres-pbf11.pbf",
            "subdiv": 2,
            "batch_point_size": 15000000, # 15M => 104 batching points
            "max_geom_mem_mb": 6259,  # 6.259GB => 6,258,291,948â€¬ bytes
            "max_bvh_mem_mb": 187360,  # 18.736GB => 18,735,951,744 bytes
            "svdag_mem_usage128": 6175304 # 6,175,304 bytes after compression
        },
        {
            "name": "islandX",
            "file": "F:/Pandora Scenes/PBF/islandX-pbf11.pbf",
            "subdiv": 0,
            "batch_point_size": 7500000,  # 7.5M => 554 batching points
            "max_geom_mem_mb": 8463,  # 8.463GB => 8,462,358,024 bytes
            "max_bvh_mem_mb": 141240,   # 14.124 => 14,123,877,120 bytes
            "svdag_mem_usage128": 23870584 # 23,870,584 bytes after compression
        }
    ]
